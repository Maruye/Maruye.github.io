<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/13/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-04-12T16:52:25.164Z" itemprop="datePublished">2025-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/04/13/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/04/13/hello-world/" data-id="cm9fr50ky0000awv8d9739k6t" data-title="Hello World" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-生存分析报告" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/04/13/%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/" class="article-date">
  <time class="dt-published" datetime="2025-04-12T16:00:00.000Z" itemprop="datePublished">2025-04-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/04/13/%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/">生存分析报告</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="生存分析重现工作报告"><a href="#生存分析重现工作报告" class="headerlink" title="生存分析重现工作报告"></a>生存分析重现工作报告</h1><h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h2><p>本报告基于 IBM Telco 客户流失数据，使用 Python 在服务器 Notebook 环境中重现 Databricks 环境下的生存分析工作。报告分为以下五个主要部分，每一部分详细描述了数据加载预处理、模型构建、结果分析及图表展示等过程。报告的总体框架如下：</p>
<ol>
<li><p><strong>数据加载与预处理</strong>  </p>
<ul>
<li>下载并加载 IBM Telco 客户流失数据（CSV 格式）。  </li>
<li>对数据进行清洗与转换，生成“青铜级”（原始数据）和“银级”（衍生数据）表。  </li>
<li>使用 Spark SQL 创建数据库和 Parquet 表（不依赖 Databricks 特有的 Delta Lake）。</li>
</ul>
</li>
<li><p><strong>Kaplan-Meier 生存分析</strong>  </p>
<ul>
<li>利用 lifelines 库对银级数据进行非参数生存分析，拟合总体生存曲线与分组生存曲线。  </li>
<li>计算中位生存时间。  </li>
<li>利用 Log-Rank 检验比较不同组间的生存曲线差异，并从模型中提取生存概率数据。</li>
</ul>
</li>
<li><p><strong>Cox 比例风险模型分析</strong>  </p>
<ul>
<li>对银级数据进行 One-Hot 编码，构造用于 Cox 模型的输入数据框。  </li>
<li>利用 lifelines 库的 CoxPHFitter 拟合多变量生存模型，输出模型摘要与风险比图。  </li>
<li>检查比例风险假设，包括统计检验和绘制 Schoenfeld 残差图，以及 Log-log Kaplan-Meier 曲线的绘制。</li>
</ul>
</li>
<li><p><strong>Accelerated Failure Time (AFT) 模型分析</strong>  </p>
<ul>
<li>使用 Log-Logistic AFT 模型对银级数据进行参数化生存分析，估计客户生存时间。  </li>
<li>输出模型中各变量的回归系数、风险加速因子和中位生存时间。  </li>
<li>绘制模型拟合图和 Log-log Kaplan-Meier 曲线，以验证模型假设的成立情况。</li>
</ul>
</li>
<li><p><strong>Customer Lifetime Value (CLTV) 分析</strong>  </p>
<ul>
<li>基于 Cox 模型预测的生存概率，计算每月预期利润，并进一步利用折现方法计算每月利润的净现值（NPV）。  </li>
<li>累计各月的 NPV 形成累计 CLTV，用以衡量客户生命周期价值。  </li>
<li>绘制累计 NPV 条形图及生存概率曲线，为决策和营销策略提供数据支持。</li>
</ul>
</li>
</ol>
<p>整个过程旨在帮助理解生存分析的基本原理、模型拟合方法以及如何通过可视化图表解读模型结果。下面依次详细介绍各部分工作内容。</p>
<hr>
<h2 id="2-数据加载与预处理"><a href="#2-数据加载与预处理" class="headerlink" title="2. 数据加载与预处理"></a>2. 数据加载与预处理</h2><h3 id="2-1-代码主要思路"><a href="#2-1-代码主要思路" class="headerlink" title="2.1 代码主要思路"></a>2.1 代码主要思路</h3><ul>
<li><p><strong>创建 SparkSession</strong><br>使用 <code>SparkSession.builder</code> 创建 Spark 会话，并设置日志级别为 ERROR，避免干扰输出信息。</p>
</li>
<li><p><strong>数据下载及目录管理</strong><br>检查指定数据目录是否存在；如果存在旧文件则删除，并从 GitHub 下载最新的 CSV 数据文件。<br>关键代码片段如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> os.path.isfile(csv_file):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;检测到已有 CSV 文件，正在删除...&quot;</span>)</span><br><span class="line">    os.remove(csv_file)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;开始下载数据...&quot;</span>)</span><br><span class="line">r = requests.get(url)</span><br><span class="line"><span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(csv_file, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(r.content)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;下载完成。&quot;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>数据读取</strong><br>使用 Spark 的 <code>read.format(&quot;csv&quot;)</code> 方法直接读取 CSV 数据。<br>为方便后续处理，将所有列名转换为小写（例如 “Churn” 转为 “churn”），这样可以保证后续字段名称保持一致。</p>
</li>
<li><p><strong>构建银级数据表</strong><br>对原始数据进行转换：  </p>
<ul>
<li>将字段 “churn” 的取值由 “Yes”&#x2F;“No” 转换为 1&#x2F;0 数值型，便于生存分析模型使用。  </li>
<li>筛选出合同类型为 “Month-to-month” 且互联网服务不为 “No” 的记录，保证数据具有代表性（该部分数据用于后续模型分析）。</li>
</ul>
</li>
<li><p><strong>数据存储</strong><br>将处理后的“青铜级”（原始数据）和“银级”（衍生数据）分别写入 Parquet 格式，再通过 Spark SQL 创建数据库并注册这两个表。</p>
</li>
</ul>
<h3 id="2-2-代码输出解析"><a href="#2-2-代码输出解析" class="headerlink" title="2.2 代码输出解析"></a>2.2 代码输出解析</h3><ul>
<li><strong>数据下载与加载</strong><br>当程序检测到旧的 CSV 文件时，会删除并重新下载数据。程序输出提示“下载完成。”表明数据已正确获取。  </li>
<li><strong>青铜数据预览</strong><br>输出结果显示前 5 行数据，字段包括 customerid、gender、seniorcitizen、partner、tenure、phoneservice 等。  </li>
<li><strong>银级数据预览</strong><br>经过转换后的银级数据中，“churn” 字段已经由 “Yes”&#x2F;“No” 变为数值 1&#x2F;0；同时数据仅包含 “Month-to-month” 合同且提供互联网服务的记录。这为后续生存分析提供了清洁且准确的数据集。</li>
</ul>
<hr>
<h2 id="3-Kaplan-Meier-生存分析"><a href="#3-Kaplan-Meier-生存分析" class="headerlink" title="3. Kaplan-Meier 生存分析"></a>3. Kaplan-Meier 生存分析</h2><h3 id="3-1-代码主要思路"><a href="#3-1-代码主要思路" class="headerlink" title="3.1 代码主要思路"></a>3.1 代码主要思路</h3><ul>
<li><strong>数据转换</strong><br>将银级数据表转换为 Pandas DataFrame，因为 lifelines 库需要 Pandas 数据。  </li>
<li><strong>模型拟合</strong><br>创建 <code>KaplanMeierFitter</code> 实例，利用银级数据中的 “tenure”（生存时间）和 “churn”（事件指标）进行拟合，得到总体生存曲线。  </li>
<li><strong>生存曲线绘图</strong><br>使用 <code>kmf.plot()</code> 方法绘制生存曲线，图表的标题、横轴和纵轴均用英文（例如 “Kaplan-Meier Overall Survival Curve”, “Survival Time (Months)”, “Survival Probability”），其余代码注释和输出均为中文。  </li>
<li><strong>中位生存时间输出</strong><br>代码通过 <code>kmf.median_survival_time_</code> 得到中位生存时间，本例输出为 34 个月，表明一半客户的生存时间（即持续使用服务的时间）大于 34 个月。  </li>
<li><strong>分组生存分析</strong><br>编写辅助函数 <code>plot_km(col)</code> 对指定协变量（如 gender、onlinesecurity）进行分组分析，对每个组分别拟合 Kaplan-Meier 曲线，并在同一图中绘制比较；同时通过 <code>print_logrank(col)</code> 输出 Log-Rank 检验结果，判断各分组生存曲线是否有显著差异。  </li>
<li><strong>特定分组的生存概率提取</strong><br>辅助函数 <code>get_survival_probs(col, val)</code> 用于提取例如 “internetservice” 为 “DSL” 的分组生存曲线，并显示前 10 个月的生存概率值。</li>
</ul>
<h3 id="3-2-关键公式说明"><a href="#3-2-关键公式说明" class="headerlink" title="3.2 关键公式说明"></a>3.2 关键公式说明</h3><p>在 Kaplan-Meier 模型中，生存函数 ( S(t) ) 定义为：</p>
<p>$$ S(t) &#x3D; \prod_{t_i \leq t} \left( 1 - \frac{d_i}{n_i} \right) $$</p>
<p>其中：  </p>
<ul>
<li>$ t_i $ 表示事件发生的时间点  </li>
<li>$ d_i $ 为时间 $ t_i $ 时发生事件的个数  </li>
<li>$ n_i $ 为 $ t_i $ 时处于风险集中的个体数</li>
</ul>
<h3 id="3-3-输出结果解析及图像解读"><a href="#3-3-输出结果解析及图像解读" class="headerlink" title="3.3 输出结果解析及图像解读"></a>3.3 输出结果解析及图像解读</h3><ul>
<li><p><strong>中位生存时间输出</strong><br>输出 “中位生存时间: 34.0”，意味着 50% 的客户在 34 个月内（或超过 34 个月）仍保持订阅状态。</p>
</li>
<li><p><strong>Log-Rank 检验输出</strong><br>根据不同协变量（如 gender、onlinesecurity）的 Log-Rank 检验结果，可以判断不同组间的生存曲线是否显著不同。<br>例如，对于 “onlinesecurity” 分组，p 值非常低（小于 0.005），说明该协变量对生存曲线有显著影响。</p>
</li>
<li><p><strong>Kaplan-Meier 生存曲线图</strong><br>图中的横轴 “Survival Time (Months)” 表示生存时间（月），纵轴 “Survival Probability” 表示生存概率。曲线起点在 (0, 1.0) 表示在 t&#x3D;0 时生存概率为 100%，随着时间推移曲线逐渐下降。</p>
<p><img src="/./images/2.1.png" alt="数据分析图表"><br><img src="/./images/2.2.png" alt="数据分析图表"><br><img src="/./images/2.3.png" alt="数据分析图表"></p>
</li>
</ul>
<hr>
<h2 id="4-Cox-比例风险模型分析"><a href="#4-Cox-比例风险模型分析" class="headerlink" title="4. Cox 比例风险模型分析"></a>4. Cox 比例风险模型分析</h2><h3 id="4-1-代码主要思路"><a href="#4-1-代码主要思路" class="headerlink" title="4.1 代码主要思路"></a>4.1 代码主要思路</h3><ul>
<li><p><strong>数据准备</strong><br>从银级数据中提取出“churn”、“tenure”及部分经过 One-Hot 编码的协变量（如 dependents_Yes、internetservice_DSL、onlinebackup_Yes、techsupport_Yes），构造模型输入数据框。</p>
</li>
<li><p><strong>One-Hot 编码说明</strong><br>数据中使用了 Pandas 的 <code>get_dummies</code> 方法来对分类变量进行 One-Hot 编码，保留所有类别，避免因自动删除第一列（drop_first）而影响变量解释。在模型数据框中，选择部分变量作为模型输入。</p>
</li>
<li><p><strong>模型拟合</strong><br>利用 lifelines 库中的 <code>CoxPHFitter</code> 类拟合 Cox 比例风险模型。模型基于公式：</p>
<p>$$<br>h(t \mid X) &#x3D; h_0(t) \exp(\beta X)<br>$$</p>
<p>其中：  </p>
<ul>
<li>$ h(t \mid X) $ 为个体在时间 t 的风险率  </li>
<li>$ h_0(t) $ 为基线风险率  </li>
<li>$ \beta $ 为回归系数  </li>
<li>$ X $ 为协变量向量</li>
</ul>
</li>
<li><p><strong>模型输出解析</strong><br>模型摘要输出中包含：</p>
<ul>
<li>各协变量的回归系数（coef），负值表明该协变量与风险呈负相关；</li>
<li>风险比（exp(coef)），例如 risk ratio 为 0.72 表明该变量使风险降低 28%；</li>
<li>置信区间、p 值等统计信息，用于判断变量是否显著。</li>
</ul>
</li>
<li><p><strong>风险比图</strong><br>利用 <code>cph.plot(hazard_ratios=True)</code> 绘制风险比图，横轴表示变量名称，纵轴表示风险比值。图中风险比值为 1 表示无风险变化，低于 1 表示降低风险，高于 1 则表示增加风险。</p>
</li>
<li><p><strong>比例风险假设检验</strong><br>使用 <code>cph.check_assumptions(...)</code> 方法进行比例风险假设检验，通过统计检验和 Schoenfeld 残差图判断模型是否满足假设。  </p>
<ul>
<li>当 p 值低于阈值（如 0.05）时，说明某协变量可能违反比例风险假设。</li>
<li>模型输出中同时给出建议，如对于只有两个取值的变量，可能建议进行分层（stratification）。</li>
</ul>
</li>
<li><p><strong>Log-log Kaplan-Meier 曲线</strong><br>辅助函数 <code>plot_km_loglog(col)</code> 用于绘制各协变量分组对应的 Log-log 转换后的 Kaplan-Meier 曲线，该图的横轴为 log(Time)，纵轴为 log(-log(Survival Probability))。通过图形直观观察曲线是否平行，可进一步判断比例风险假设是否成立。</p>
</li>
</ul>
<h3 id="4-2-输出结果解析及图像解读"><a href="#4-2-输出结果解析及图像解读" class="headerlink" title="4.2 输出结果解析及图像解读"></a>4.2 输出结果解析及图像解读</h3><ul>
<li><p><strong>模型摘要输出</strong><br>模型摘要显示例如：  </p>
<ul>
<li><code>dependents_Yes</code> 的回归系数为 -0.33，对应风险比 $ \exp(-0.33) \approx 0.72 $（风险降低 28%）；  </li>
<li>所有变量的 p 值均小于 0.005，说明它们在统计上均显著。  </li>
<li>另外，模型的 Concordance 值为 0.64，说明模型在预测时序上具有一定的准确性。</li>
</ul>
</li>
<li><p><strong>风险比图解读</strong><br>图中显示各变量的风险比条形图，横轴为变量名称，纵轴为风险比。若条形图低于 1，则该变量与风险负相关（有保护作用）；若高于 1，则与风险正相关（有促风险作用）。<br><img src="/./images/3.1.png" alt="数据分析图表"></p>
</li>
<li><p><strong>比例风险假设检验及 Schoenfeld 残差图</strong><br>检验输出指出部分变量（如 internetservice_DSL、onlinebackup_Yes、techsupport_Yes）的 p 值小于 0.05，提示这些变量可能违反比例风险假设。<br>Schoenfeld 残差图会展示各变量残差随时间的变化趋势，如果趋势线不平稳，则说明假设可能不成立。<br><img src="/images/3.2.png" alt="数据分析图表"><br><img src="/images/3.3.png" alt="数据分析图表"><br><img src="/images/3.4.png" alt="数据分析图表"><br><img src="/images/3.5.png" alt="数据分析图表"></p>
</li>
<li><p><strong>Log-log KM 曲线图</strong><br>绘制的 log-log Kaplan-Meier 曲线，其横轴是 $\log(\text{Time})$，纵轴是 $\log(-\log(S(t)))$。  </p>
<ul>
<li>如果不同分组的曲线平行，则表示各组间的生存函数比例关系稳定，比例风险假设得以满足；  </li>
<li>如果曲线明显交叉或不平行，则表明比例风险假设可能存在问题。<br><img src="/./images/3.6.png" alt="数据分析图表"><br><img src="/./images/3.7.png" alt="数据分析图表"><br><img src="/./images/3.8.png" alt="数据分析图表"><br><img src="/./images/3.9.png" alt="数据分析图表"></li>
</ul>
</li>
</ul>
<hr>
<h2 id="5-Accelerated-Failure-Time-AFT-模型分析"><a href="#5-Accelerated-Failure-Time-AFT-模型分析" class="headerlink" title="5. Accelerated Failure Time (AFT) 模型分析"></a>5. Accelerated Failure Time (AFT) 模型分析</h2><h3 id="5-1-代码目的"><a href="#5-1-代码目的" class="headerlink" title="5.1 代码目的"></a>5.1 代码目的</h3><p>本部分旨在使用 Accelerated Failure Time 模型中的 Log-Logistic 分布来对客户流失数据进行分析。主要工作包括：</p>
<ol>
<li>从 Spark 中加载“银级数据”（经过预处理后的数据），转换为 Pandas DataFrame。</li>
<li>对指定的分类变量进行 One-Hot 编码，生成虚拟变量。</li>
<li>构造 AFT 模型所需要的数据框，并选取部分变量进行建模。</li>
<li>利用 Log-Logistic AFT 模型对数据进行拟合，输出模型统计摘要并绘制模型拟合图。</li>
<li>通过辅助函数绘制 Log-log 转换后的 Kaplan-Meier 曲线，检查模型假设。</li>
</ol>
<h3 id="5-2-关键思路与实现"><a href="#5-2-关键思路与实现" class="headerlink" title="5.2 关键思路与实现"></a>5.2 关键思路与实现</h3><h4 id="5-2-1-数据加载和-One-Hot-编码"><a href="#5-2-1-数据加载和-One-Hot-编码" class="headerlink" title="5.2.1 数据加载和 One-Hot 编码"></a>5.2.1 数据加载和 One-Hot 编码</h4><ul>
<li><p><strong>数据加载</strong><br>代码使用 <code>spark.table(&quot;silver_monthly_customers&quot;).toPandas()</code> 将 Spark 中注册的银级数据加载为 Pandas DataFrame，方便 lifelines 库处理数据。</p>
</li>
<li><p><strong>One-Hot 编码</strong><br>为了使分类变量能够在模型中使用，代码利用 <code>pd.get_dummies</code> 对 8 个变量（partner, multiplelines, internetservice, onlinesecurity, onlinebackup, deviceprotection, techsupport, paymentmethod）进行 One-Hot 编码。<br>输出中显示编码后的数据集拥有 32 个字段，其中新生成的虚拟变量名称形如 <code>partner_Yes</code>、<code>multiplelines_Yes</code>、<code>internetservice_DSL</code> 等。该步骤确保后续模型构造时变量维度一致。</p>
</li>
</ul>
<h4 id="5-2-2-构造模型数据框"><a href="#5-2-2-构造模型数据框" class="headerlink" title="5.2.2 构造模型数据框"></a>5.2.2 构造模型数据框</h4><ul>
<li>根据需求，从编码后的数据集中选取模型关键变量：  <ul>
<li>事件指示变量：<code>churn</code>  </li>
<li>持续时间变量：<code>tenure</code>  </li>
<li>部分关键协变量（例如：<code>partner_Yes</code>、<code>multiplelines_Yes</code>、<code>internetservice_DSL</code>、<code>onlinesecurity_Yes</code>、<code>onlinebackup_Yes</code>、<code>deviceprotection_Yes</code>、<code>techsupport_Yes</code>、<code>paymentmethod_Bank transfer (automatic)</code>、<code>paymentmethod_Credit card (automatic)</code>）</li>
</ul>
</li>
<li>这里将 <code>churn</code> 转换为 float 类型，符合模型输入要求。</li>
</ul>
<h4 id="5-2-3-模型拟合"><a href="#5-2-3-模型拟合" class="headerlink" title="5.2.3 模型拟合"></a>5.2.3 模型拟合</h4><ul>
<li><p><strong>模型选用</strong><br>使用 lifelines 库中的 <code>LogLogisticAFTFitter()</code> 来构建 Log-Logistic AFT 模型。  </p>
</li>
<li><p><strong>模型公式</strong><br>AFT 模型假定个体生存时间 $ T $ 与协变量 $ X $ 的关系可以表示为：<br>$$<br>\log(T) &#x3D; \mu + \beta X + \sigma \epsilon<br>$$<br>其中，$\mu$ 为截距，$\beta$ 为协变量系数，$\sigma$ 为尺度参数，$\epsilon$ 是随机误差项（在 Log-Logistic 模型中满足对数-逻辑分布）。  </p>
</li>
<li><p><strong>模型输出</strong><br>调用 <code>aft.fit(...)</code> 进行模型拟合后，通过 <code>aft.print_summary()</code> 输出模型统计摘要。输出摘要显示了每个变量的回归系数（coef）、标准误（se(coef)）、风险加速因子 $ \exp(\text{coef}) $ 以及其置信区间和统计显著性（z 值、p 值等）。</p>
<ul>
<li>例如，<code>internetservice_DSL</code> 的 coef 为 0.38，对应 $ \exp(0.38)\approx 1.47 $ ，表示当互联网服务为 DSL 时，对应的加速因子为 1.47，即相对于基线，其生存时间缩短的比例大约为 1&#x2F;1.47。</li>
</ul>
</li>
<li><p><strong>中位生存时间</strong><br>模型中计算出的中位生存时间最初以 log-odds 形式输出，代码使用 <code>np.exp(aft.median_survival_time_)</code> 将其转换为实际的时间值，本例中输出为 135.51（单位为月份）。</p>
</li>
</ul>
<h4 id="5-2-4-模型拟合图"><a href="#5-2-4-模型拟合图" class="headerlink" title="5.2.4 模型拟合图"></a>5.2.4 模型拟合图</h4><ul>
<li>调用 <code>aft.plot()</code> 绘制模型拟合结果图。  </li>
<li>图表中的横轴为 “Duration (Months)”（持续时间），纵轴为 “Log(Hazard)”（对数风险），图表标题为 “Log-Logistic AFT Model Fit”。  </li>
<li>该图帮助我们直观观察模型拟合情况，如回归线的形态及不同时间段的风险变化趋势。</li>
</ul>
<h4 id="5-2-5-验证模型假设-——-Log-log-Kaplan-Meier-曲线"><a href="#5-2-5-验证模型假设-——-Log-log-Kaplan-Meier-曲线" class="headerlink" title="5.2.5 验证模型假设 —— Log-log Kaplan-Meier 曲线"></a>5.2.5 验证模型假设 —— Log-log Kaplan-Meier 曲线</h4><ul>
<li><p>为验证 AFT 模型的假设（例如比例赔率假设），代码首先利用 Kaplan-Meier 方法拟合总体生存函数，得到生存曲线 $ S(t) $。</p>
</li>
<li><p>自定义函数 <code>plot_km_logOdds(col)</code> 针对指定分类变量绘制 log-log Kaplan-Meier 曲线。  </p>
</li>
<li><p>在函数中，计算生存函数转换公式：<br>$$<br>\text{failureOdds} &#x3D; \frac{\log(1 - S)}{S}<br>$$</p>
</li>
<li><p>曲线绘制后，横轴为 $\log(\text{Time})$，纵轴为 $ \log(1-S) &#x2F; S $，通过观察各分组曲线是否平行，帮助评估模型假设是否满足。</p>
</li>
</ul>
<h3 id="5-3-输出结果解读"><a href="#5-3-输出结果解读" class="headerlink" title="5.3. 输出结果解读"></a>5.3. 输出结果解读</h3><h4 id="5-3-1-模型统计摘要"><a href="#5-3-1-模型统计摘要" class="headerlink" title="5.3.1 模型统计摘要"></a>5.3.1 模型统计摘要</h4><ul>
<li>输出显示共有 3351 个观察值，1556 个事件（客户流失）。</li>
<li>每个变量的 p 值均小于 0.005，表明所有协变量在统计上均显著。</li>
<li>Risk factor（即 $ \exp(\text{coef}) $）的数值解释：<ul>
<li>如 <code>internetservice_DSL</code> 的 $ \exp(0.38) \approx 1.47 $ 表示 DSL 用户的流失风险相比基线加速因子增加 47%（实际上意味着其生存时间相对缩短）。</li>
</ul>
</li>
<li>模型的 Concordance 为 0.73，说明模型具有较好的排序能力。</li>
</ul>
<h4 id="5-3-2-中位生存时间"><a href="#5-3-2-中位生存时间" class="headerlink" title="5.3.2 中位生存时间"></a>5.3.2 中位生存时间</h4><ul>
<li>输出 “中位生存时间: 135.51” 表示在当前模型下，50% 的客户预期在 135.51 个月内（大约 11 年多）达到流失事件，这里主要体现了 AFT 模型的参数效果，通常用于比较不同模型或方案下的客户寿命。</li>
</ul>
<h4 id="5-3-3-模型拟合图"><a href="#5-3-3-模型拟合图" class="headerlink" title="5.3.3 模型拟合图"></a>5.3.3 模型拟合图</h4><ul>
<li>图中横轴显示 “Duration (Months)”，纵轴显示 “Log(Hazard)”。  </li>
<li>通过该图可以观察模型如何对风险随时间的变化做出拟合。如果拟合曲线较为平滑，则说明模型在该分布假设下表现较为合理。<br><img src="/images/4.1.png" alt="数据分析图表"></li>
</ul>
<h4 id="5-3-4-Log-log-Kaplan-Meier-曲线图解读"><a href="#5-3-4-Log-log-Kaplan-Meier-曲线图解读" class="headerlink" title="5.3.4 Log-log Kaplan-Meier 曲线图解读"></a>5.3.4 Log-log Kaplan-Meier 曲线图解读</h4><ul>
<li>对于每个分组（例如 partner、multiplelines、internetservice 等），绘制的 log-log 曲线可以直观展示：<ul>
<li>横轴为 $\log(\text{Time})$：时间的对数值；</li>
<li>纵轴为 $ \log(1-S)&#x2F;S $。</li>
</ul>
</li>
<li>如果不同分组的曲线大致平行，则支持模型假设（例如，比例赔率假设）成立；若出现明显不平行或交叉，则可能提示需要对模型进行调整，如分层或引入时间依赖协变量。<br><img src="/images/4.2.png" alt="数据分析图表"><br><img src="/images/4.3.png" alt="数据分析图表"><br><img src="/images/4.4.png" alt="数据分析图表"><br><img src="/images/4.5.png" alt="数据分析图表"><br><img src="/images/4.6.png" alt="数据分析图表"><br><img src="/images/4.7.png" alt="数据分析图表"><br><img src="/images/4.8.png" alt="数据分析图表"><br><img src="/images/4.9.png" alt="数据分析图表"></li>
</ul>
<h4 id="5-3-5-总结"><a href="#5-3-5-总结" class="headerlink" title="5.3.5 总结"></a>5.3.5 总结</h4><p>该部分工作通过 Log-Logistic AFT 模型详细展示了如何对客户流失数据进行参数化生存分析。输出的模型摘要和中位生存时间为业务决策提供了数据依据，同时通过多个图表帮助直观验证模型假设。</p>
<hr>
<h2 id="6-Customer-Lifetime-Value-CLTV-分析"><a href="#6-Customer-Lifetime-Value-CLTV-分析" class="headerlink" title="6. Customer Lifetime Value (CLTV) 分析"></a>6. Customer Lifetime Value (CLTV) 分析</h2><h3 id="6-1-代码目的"><a href="#6-1-代码目的" class="headerlink" title="6.1 代码目的"></a>6.1 代码目的</h3><p>本部分旨在基于 Cox 比例风险模型的输出和生存函数预测，进一步构造客户生命周期价值（Customer Lifetime Value, CLTV）仪表板。主要工作包括：</p>
<ol>
<li>从 Spark 加载银级数据并转换为 Pandas DataFrame。</li>
<li>对指定的分类变量进行 One-Hot 编码，构造用于 Cox 模型的数据框，并拟合模型。</li>
<li>模拟仪表板参数（类似 Databricks 中的 widgets），构造一个包含预测生存概率的输入 DataFrame。</li>
<li>基于模型预测结果，计算每月预期利润及其净现值（NPV），进而计算累计 NPV。</li>
<li>绘制累计 NPV 条形图及生存概率曲线图供仪表板展示。</li>
</ol>
<h3 id="6-2-关键思路与实现"><a href="#6-2-关键思路与实现" class="headerlink" title="6.2 关键思路与实现"></a>6.2 关键思路与实现</h3><h4 id="6-2-1-数据加载与-One-Hot-编码"><a href="#6-2-1-数据加载与-One-Hot-编码" class="headerlink" title="6.2.1 数据加载与 One-Hot 编码"></a>6.2.1 数据加载与 One-Hot 编码</h4><ul>
<li><strong>数据加载</strong><br>使用 <code>spark.table(&quot;silver_monthly_customers&quot;).toPandas()</code> 将银级数据加载为 Pandas DataFrame。</li>
<li><strong>One-Hot 编码</strong><br>对与模型相关的变量（dependents, internetservice, onlinebackup, techsupport, paperlessbilling）进行 One-Hot 编码。注意：由于原数据列均为小写，所以直接使用小写名称。</li>
<li><strong>构造模型数据框</strong><br>从编码后的 DataFrame 中选取 <code>churn</code>、<code>tenure</code> 以及关键的虚拟变量（如 <code>dependents_Yes</code>、<code>internetservice_DSL</code>、<code>onlinebackup_Yes</code>、<code>techsupport_Yes</code>）构造 Cox 模型输入数据框，并将 <code>churn</code> 转换为 float 型。</li>
</ul>
<h4 id="6-2-2-拟合-Cox-比例风险模型"><a href="#6-2-2-拟合-Cox-比例风险模型" class="headerlink" title="6.2.2 拟合 Cox 比例风险模型"></a>6.2.2 拟合 Cox 比例风险模型</h4><ul>
<li>使用 <code>CoxPHFitter</code> 拟合 Cox 模型，输出模型统计摘要和风险比图。  </li>
<li>模型输出为之后 CLTV 分析提供了生存函数预测的基础。</li>
</ul>
<h4 id="6-2-3-模拟仪表板参数"><a href="#6-2-3-模拟仪表板参数" class="headerlink" title="6.2.3 模拟仪表板参数"></a>6.2.3 模拟仪表板参数</h4><ul>
<li>因原代码中使用 Databricks 的 widgets，本代码使用 Python 中的字典模拟相关参数。  </li>
<li>模拟参数包括各模型变量的激活状态（设为 0 表示未激活）和“ internal rate of return”，默认为 10% 年化。</li>
<li>辅助函数 <code>get_widget_values()</code> 返回一个 DataFrame，其列仅包括模型所使用的变量，供生存函数预测使用。</li>
</ul>
<h4 id="6-2-4-计算-CLTV"><a href="#6-2-4-计算-CLTV" class="headerlink" title="6.2.4 计算 CLTV"></a>6.2.4 计算 CLTV</h4><ul>
<li>利用训练好的 Cox 模型及模拟输入，通过 <code>cph.predict_survival_function</code> 预测生存概率曲线。</li>
<li>在构造的生存函数表中：<ul>
<li><p>第一行固定为 1（表示初始时刻 t&#x3D;0 生存概率为 1）。</p>
</li>
<li><p>按照时间（合同月份），计算每个月的平均预期利润 &#x3D; 生存概率 × 每月固定利润（此处设为 30）。</p>
</li>
<li><p>利用内部收益率（折现率）计算每月预期利润的净现值（NPV），公式为：<br>$$<br>\text{NPV} &#x3D; \frac{\text{Avg Expected Monthly Profit}}{(1 + \text{月利率})^{\text{Contract Month}}}<br>$$</p>
</li>
<li><p>计算累计 NPV 作为评估客户生命周期价值的指标。</p>
</li>
</ul>
</li>
</ul>
<h4 id="6-2-5-图表绘制"><a href="#6-2-5-图表绘制" class="headerlink" title="6.2.5 图表绘制"></a>6.2.5 图表绘制</h4><ul>
<li><p><strong>累计 NPV 条形图</strong><br>对于 12、24、36 个月，绘制条形图。图中横轴显示 “Contract Period”，纵轴显示 “Cumulative NPV”，标题为 “Cumulative NPV at Key Contract Months”。<br>图表直观展示了在不同合同月数下的累计净现值，帮助业务判断对客户的最大投入。</p>
</li>
<li><p><strong>生存概率曲线图</strong><br>绘制生存概率曲线，横轴为 “Contract Month”，纵轴为 “Survival Probability”，标题为 “Survival Probability Curve”。<br>该图展示了随合同月份推移，生存概率的下降趋势，反映客户续订和流失情况。</p>
</li>
</ul>
<h3 id="6-3-输出结果解读"><a href="#6-3-输出结果解读" class="headerlink" title="6.3 输出结果解读"></a>6.3 输出结果解读</h3><h4 id="6-3-1-模型摘要"><a href="#6-3-1-模型摘要" class="headerlink" title="6.3.1 模型摘要"></a>6.3.1 模型摘要</h4><ul>
<li>输出的 Cox 模型摘要中，各变量均显示了统计指标（coef、exp(coef)、p 值等）。所有 p 值均小于 0.005，提示这些变量均显著，模型具有较好的预测能力。</li>
<li>模型的 Concordance 值为 0.64，表明模型对数据排序有一定的预测准确性。</li>
</ul>
<h4 id="6-3-2-仪表板数据表"><a href="#6-3-2-仪表板数据表" class="headerlink" title="6.3.2 仪表板数据表"></a>6.3.2 仪表板数据表</h4><ul>
<li>输出的仪表板数据表显示：<ul>
<li>“Survival Probability” 随着合同月份增加逐步下降，符合常理；</li>
<li>“Monthly Profit for the Selected Plan” 固定为 30；</li>
<li>“Avg Expected Monthly Profit” 随生存概率变化而下降；</li>
<li>“NPV of Avg Expected Monthly Profit” 考虑折现效果逐月递减；</li>
<li>“Cumulative NPV” 为各月 NPV 的累加值，反映整体客户价值增长趋势。</li>
</ul>
</li>
</ul>
<p>例如，合同第 12 个月时，累计 NPV 为 251.40，表示在 12 个月内预计客户为企业带来的净现值约为 251.40（单位视具体业务而定）。</p>
<h4 id="6-3-3-图表解读"><a href="#6-3-3-图表解读" class="headerlink" title="6.3.3 图表解读"></a>6.3.3 图表解读</h4><ul>
<li><p><strong>累计 NPV 条形图</strong><br>图表显示三根条形分别代表 12、24、36 个月下的累计 NPV。  </p>
<ul>
<li>横轴标签 “12 Months”, “24 Months”, “36 Months” 表示对应合同月份；  </li>
<li>纵轴 “Cumulative NPV” 显示相应时间点的累计净现值。<br>通过对比，可发现随着时间推移累计 NPV 呈上升趋势，这说明客户价值随时间不断积累，但增速可能会逐渐放缓。<br><img src="/./images/5.1.png" alt="数据分析图表"></li>
</ul>
</li>
<li><p><strong>生存概率曲线图</strong><br>图表中横轴为 “Contract Month”（合同月份），纵轴为 “Survival Probability”（生存概率）。  </p>
<ul>
<li>起始时（合同第 1 个月）生存概率为 1；  </li>
<li>随着月份增加，曲线逐渐下降，显示客户流失风险逐步加大。<br>该曲线帮助我们直观了解客户在不同时间段续订的可能性，为产品定价和推广策略提供支持。<br><img src="/./images/5.2.png" alt="数据分析图表"></li>
</ul>
</li>
</ul>
<h3 id="6-4-总结"><a href="#6-4-总结" class="headerlink" title="6.4 总结"></a>6.4 总结</h3><p>通过 Accelerated Failure Time 模型分析，可以获得有关客户生存时间的参数化估计（如中位生存时间 135.51 个月）以及各协变量对生存时间的影响（通过回归系数和风险加速因子）。同时，通过 Log-log Kaplan-Meier 曲线，能够检查模型假设是否满足。<br>在 CLTV 分析部分，基于 Cox 模型预测的生存概率，计算了每月预期利润及其净现值，并求累计 NPV，生成仪表板表格和图表，直观反映客户生命周期价值，便于企业制定营销和客户维护策略。</p>
<h2 id="7-总结与建议"><a href="#7-总结与建议" class="headerlink" title="7. 总结与建议"></a>7. 总结与建议</h2><p>本报告通过以下五个部分详细描述了数据加载与预处理、Kaplan-Meier 生存分析、Cox 比例风险模型、Accelerated Failure Time 模型以及 CLTV 分析的全过程。总体结论如下：</p>
<ol>
<li><p><strong>数据预处理</strong>：<br>从原始数据中构建青铜级与银级数据，为后续模型分析奠定了坚实的数据基础。</p>
</li>
<li><p><strong>生存分析</strong>：<br>通过 Kaplan-Meier 方法与 Cox 模型，分别获得了总体生存曲线、中位生存时间及各协变量对风险的影响，为客户流失风险评估提供了直观指标。</p>
</li>
<li><p><strong>参数化生存模型</strong>：<br>AFT 模型详细揭示了客户生存时间的加速效应，通过中位生存时间及模型拟合图，帮助理解变量对生存时间的影响。</p>
</li>
<li><p><strong>客户生命周期价值</strong>：<br>基于 Cox 模型预测的生存概率，计算了每月预期利润的净现值，并求得累计 NPV，直观反映客户整体价值，有助于企业在客户保留策略和营销规划中做出数据驱动的决策。</p>
</li>
<li><p><strong>模型检验与图表解读</strong>：<br>多幅图表（生存曲线、风险比图、拟合图、Log-log 曲线及 CLTV 分析图）为模型输出提供了直观验证，对模型假设检验和变量解读均起到关键作用。</p>
</li>
</ol>
<p>建议后续在模型应用时：</p>
<ul>
<li>持续优化数据预处理方法，确保数据质量；</li>
<li>根据比例风险假设检验结果，必要时对模型进行调整（例如分层或引入时间依赖变量）；</li>
<li>定期更新数据和模型，动态监控客户流失与生命周期价值。</li>
</ul>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/04/13/%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/" data-id="cm9fr50l10001awv832cahv9r" data-title="生存分析报告" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">April 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/04/13/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2025/04/13/%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/">生存分析报告</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>